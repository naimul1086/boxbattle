<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Box Battle - Dots & Boxes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap');

        * {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        body {
            font-family: 'Fredoka', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
            overflow-x: hidden;
            min-height: 100vh;
            min-height: -webkit-fill-available;
        }

        #game-wrapper {
            position: relative;
            width: 100%;
            max-width: min(95vw, 500px);
            margin: 0 auto;
            aspect-ratio: 1 / 1;
        }

        svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: visible;
        }

        .line {
            stroke-linecap: round;
            transition: stroke 0.2s ease;
        }

        .line:hover:not(.active) {
            stroke: rgba(255, 255, 255, 0.3);
        }

        .line.active {
            cursor: default;
        }

        .dot {
            pointer-events: none;
        }

        .box-fill {
            opacity: 0;
            transition: opacity 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .box-fill.completed {
            opacity: 1;
        }

        .p1-color { color: #3b82f6; }
        .p2-color { color: #ef4444; }
        .p1-fill { fill: rgba(59, 130, 246, 0.4); }
        .p2-fill { fill: rgba(239, 68, 68, 0.4); }

        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 255, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
        }

        .turn-active {
            animation: pulse-border 2s infinite;
        }

        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
        }

        .thinking-dot {
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .thinking-dot:nth-child(1) { animation-delay: -0.32s; }
        .thinking-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .mode-btn {
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: transparent;
            color: white;
        }

        .voice-wave {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            height: 20px;
        }

        .voice-bar {
            width: 3px;
            background: currentColor;
            border-radius: 3px;
            animation: wave 1s ease-in-out infinite;
        }

        @keyframes wave {
            0%, 100% { transform: scaleY(0.5); }
            50% { transform: scaleY(1); }
        }

        /* Mobile optimizations */
        @media (max-width: 640px) {
            .game-card {
                padding: 0.75rem;
            }
            .game-card .text-3xl {
                font-size: 1.5rem;
            }
            .game-card .text-xs {
                font-size: 0.65rem;
            }
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center p-2 sm:p-4">

    <!-- Setup Modal -->
    <div id="setup-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4 overflow-y-auto">
        <div class="bg-gray-800 p-4 sm:p-8 rounded-2xl sm:rounded-3xl w-full max-w-md mx-auto shadow-2xl border border-gray-700 my-auto">
            <h1 class="text-2xl sm:text-4xl font-bold text-center mb-1 sm:mb-2 bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-red-400">
                BOX BATTLE
            </h1>
            <p class="text-center text-gray-400 mb-4 sm:mb-8 text-sm sm:text-base">Dots & Boxes Game</p>

            <!-- Game Mode Selection -->
            <div class="mb-4 sm:mb-6">
                <label class="block text-gray-400 text-xs sm:text-sm font-bold mb-2 sm:mb-3 text-center">Select Game Mode</label>
                <div class="grid grid-cols-2 gap-2 sm:gap-4">
                    <button class="mode-btn active p-3 sm:p-4 rounded-xl border-2 border-gray-600 flex flex-col items-center gap-1 sm:gap-2" data-mode="pvp">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 sm:h-8 sm:w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                        <span class="font-semibold text-xs sm:text-sm">vs Player</span>
                    </button>
                    <button class="mode-btn p-3 sm:p-4 rounded-xl border-2 border-gray-600 flex flex-col items-center gap-1 sm:gap-2" data-mode="pvc">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 sm:h-8 sm:w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                        <span class="font-semibold text-xs sm:text-sm">vs Computer</span>
                    </button>
                </div>
            </div>

            <!-- Player Names -->
            <div class="space-y-3 sm:space-y-4 mb-4 sm:mb-6">
                <div>
                    <label class="block text-blue-400 text-xs font-bold uppercase mb-1">Player 1 Name</label>
                    <input type="text" id="p1-name-input" value="Player 1" maxlength="12" 
                        class="w-full px-3 sm:px-4 py-2 sm:py-3 bg-gray-700 rounded-lg sm:rounded-xl border-2 border-gray-600 focus:border-blue-500 focus:outline-none text-white font-semibold text-sm sm:text-base transition">
                </div>
                <div>
                    <label class="block text-red-400 text-xs font-bold uppercase mb-1" id="p2-label">Player 2 Name</label>
                    <input type="text" id="p2-name-input" value="Player 2" maxlength="12" 
                        class="w-full px-3 sm:px-4 py-2 sm:py-3 bg-gray-700 rounded-lg sm:rounded-xl border-2 border-gray-600 focus:border-red-500 focus:outline-none text-white font-semibold text-sm sm:text-base transition">
                </div>
            </div>

            <!-- Voice Settings -->
            <div class="mb-4 sm:mb-6 p-3 sm:p-4 bg-gray-700/50 rounded-xl">
                <div class="flex items-center justify-between mb-2">
                    <label class="text-gray-300 text-xs sm:text-sm font-bold flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-5 sm:w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                        </svg>
                        Voice
                    </label>
                    <button id="voice-toggle" class="px-2 sm:px-3 py-1 bg-green-600 rounded-full text-xs font-bold transition">ON</button>
                </div>
                <button id="test-voice-btn" class="w-full py-2 bg-gray-600 hover:bg-gray-500 rounded-lg text-xs sm:text-sm font-semibold transition">
                    üîä Test Voice
                </button>
            </div>

            <!-- Grid Size Selection -->
            <div class="mb-4 sm:mb-8">
                <label class="block text-gray-400 text-xs sm:text-sm font-bold mb-2 sm:mb-3 text-center">Grid Size</label>
                <div class="grid grid-cols-3 gap-2 sm:gap-3">
                    <button class="grid-select-btn py-2 rounded-lg border-2 border-gray-600 hover:border-gray-500 font-semibold text-xs sm:text-sm transition" data-size="4">4√ó4</button>
                    <button class="grid-select-btn py-2 rounded-lg border-2 border-blue-500 bg-blue-500/20 text-blue-400 font-semibold text-xs sm:text-sm transition" data-size="5">5√ó5</button>
                    <button class="grid-select-btn py-2 rounded-lg border-2 border-gray-600 hover:border-gray-500 font-semibold text-xs sm:text-sm transition" data-size="6">6√ó6</button>
                </div>
            </div>

            <button id="start-game-btn" class="w-full py-3 sm:py-4 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-400 hover:to-purple-500 rounded-xl font-bold text-base sm:text-lg shadow-lg transform transition hover:scale-105 active:scale-95">
                Start Game
            </button>
        </div>
    </div>

    <!-- Main Game UI -->
    <div id="game-ui" class="w-full max-w-lg hidden opacity-0 transition-opacity duration-500 px-2 sm:px-0 flex flex-col items-center">
        
        <!-- Header -->
        <header class="w-full mb-3 sm:mb-6 flex flex-col gap-2 sm:gap-4">
            <div class="flex justify-between items-center px-1">
                <h1 class="text-xl sm:text-3xl font-bold tracking-wider bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-red-400">
                    BOX BATTLE
                </h1>
                <!-- Only New Game button in header, no overlap -->
                <button id="new-game-btn" class="text-gray-400 hover:text-white transition p-2 rounded-lg hover:bg-gray-800" title="New Game">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z" />
                    </svg>
                </button>
            </div>

            <!-- Score Board -->
            <div class="grid grid-cols-2 gap-2 sm:gap-4 px-1">
                <div id="p1-card" class="game-card bg-gray-800 p-2 sm:p-4 rounded-lg sm:rounded-xl border-2 border-blue-500 transition-all duration-300 transform scale-105 shadow-lg shadow-blue-900/20 relative overflow-hidden">
                    <div class="absolute top-1 sm:top-2 right-1 sm:right-2 w-2 sm:w-3 h-2 sm:h-3 rounded-full bg-blue-500 animate-pulse" id="p1-indicator"></div>
                    <div class="text-xs text-blue-400 uppercase font-bold truncate pr-4" id="p1-name-display">Player 1</div>
                    <div class="text-2xl sm:text-3xl font-bold p1-color" id="score-p1">0</div>
                </div>
                <div id="p2-card" class="game-card bg-gray-800 p-2 sm:p-4 rounded-lg sm:rounded-xl border-2 border-gray-700 transition-all duration-300 opacity-70 relative overflow-hidden">
                    <div class="absolute top-1 sm:top-2 right-1 sm:right-2 w-2 sm:w-3 h-2 sm:h-3 rounded-full bg-red-500 opacity-0" id="p2-indicator"></div>
                    <div class="text-xs text-red-400 uppercase font-bold flex items-center gap-1 sm:gap-2 pr-4" id="p2-name-display">
                        <span class="truncate">Player 2</span>
                        <span id="thinking-indicator" class="hidden flex gap-0.5 sm:gap-1 flex-shrink-0">
                            <span class="w-1 sm:w-1.5 h-1 sm:h-1.5 bg-red-400 rounded-full thinking-dot"></span>
                            <span class="w-1 sm:w-1.5 h-1 sm:h-1.5 bg-red-400 rounded-full thinking-dot"></span>
                            <span class="w-1 sm:w-1.5 h-1 sm:h-1.5 bg-red-400 rounded-full thinking-dot"></span>
                        </span>
                    </div>
                    <div class="text-2xl sm:text-3xl font-bold p2-color" id="score-p2">0</div>
                </div>
            </div>
            
            <div class="text-center text-xs sm:text-sm text-gray-400 truncate px-4" id="turn-indicator">Player 1's Turn</div>
        </header>

        <!-- Game Area -->
        <main class="w-full relative flex justify-center">
            <div id="game-wrapper">
                <svg id="game-svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet">
                    <g id="layer-boxes"></g>
                    <g id="layer-lines"></g>
                    <g id="layer-dots"></g>
                </svg>
            </div>
        </main>

        <!-- Footer Controls - Restart Button Clearly Visible -->
        <footer class="mt-4 sm:mt-6 w-full flex justify-center items-center gap-4 pb-4">
            <button id="restart-btn" class="px-6 sm:px-8 py-3 sm:py-4 bg-gray-700 hover:bg-gray-600 rounded-full font-bold text-sm sm:text-base transition shadow-lg flex items-center gap-2 active:scale-95 border-2 border-gray-500 hover:border-gray-400">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                </svg>
                <span>Restart Game</span>
            </button>
        </footer>
    </div>

    <!-- Game Over Modal -->
    <div id="game-over-modal" class="fixed inset-0 modal-backdrop hidden flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 p-4 sm:p-8 rounded-2xl sm:rounded-3xl w-full max-w-sm mx-auto shadow-2xl text-center border border-gray-700 transform scale-0 transition-transform duration-500" id="game-over-content">
            <div class="mb-2 sm:mb-4 text-4xl sm:text-6xl">üèÜ</div>
            
            <!-- Voice Speaking Indicator -->
            <div id="voice-indicator" class="hidden mb-2 sm:mb-4 flex justify-center items-center gap-2 text-yellow-400">
                <div class="voice-wave">
                    <div class="voice-bar"></div>
                    <div class="voice-bar"></div>
                    <div class="voice-bar"></div>
                    <div class="voice-bar"></div>
                    <div class="voice-bar"></div>
                </div>
                <span class="text-xs sm:text-sm font-bold">Speaking...</span>
            </div>

            <h2 class="text-xl sm:text-3xl font-bold mb-1 sm:mb-2 text-white px-2" id="winner-text">Player 1 Wins!</h2>
            <p class="text-gray-400 mb-1 sm:mb-2 text-sm sm:text-base" id="final-score">5 - 3</p>
            <p class="text-yellow-400 text-xs sm:text-sm mb-4 sm:mb-6 font-semibold min-h-[16px] sm:min-h-[20px] px-2" id="voice-message"></p>
            
            <div class="flex gap-2 sm:gap-3">
                <button id="play-again-btn" class="flex-1 py-3 sm:py-4 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-400 hover:to-purple-500 rounded-lg sm:rounded-xl font-bold text-sm sm:text-lg shadow-lg transform transition hover:scale-105 active:scale-95">
                    Play Again
                </button>
                <button id="menu-btn" class="flex-1 py-3 sm:py-4 bg-gray-700 hover:bg-gray-600 rounded-lg sm:rounded-xl font-bold text-sm sm:text-lg shadow-lg transform transition hover:scale-105 active:scale-95">
                    Menu
                </button>
            </div>
        </div>
    </div>

    <canvas id="confetti-canvas"></canvas>

    <script>
        // --- Audio & Voice System ---
        let audioEnabled = true;
        let voiceEnabled = true;
        let synth, membrane, metal;
        let speechSynthesis = window.speechSynthesis;
        let voicesLoaded = false;

        function loadVoices() {
            return new Promise((resolve) => {
                let voices = speechSynthesis.getVoices();
                if (voices.length > 0) {
                    voicesLoaded = true;
                    resolve(voices);
                } else {
                    speechSynthesis.onvoiceschanged = () => {
                        voices = speechSynthesis.getVoices();
                        voicesLoaded = true;
                        resolve(voices);
                    };
                }
            });
        }

        async function initAudio() {
            if (!audioEnabled) return;
            try {
                await Tone.start();
                
                synth = new Tone.PolySynth(Tone.Synth).toDestination();
                synth.volume.value = -10;
                membrane = new Tone.MembraneSynth().toDestination();
                membrane.volume.value = -15;
                metal = new Tone.MetalSynth({
                    frequency: 200,
                    envelope: { attack: 0.001, decay: 0.1, release: 0.01 },
                    harmonicity: 5.1,
                    modulationIndex: 32,
                    resonance: 4000,
                    octaves: 1.5
                }).toDestination();
                metal.volume.value = -20;
            } catch(e) {
                console.log("Audio init failed:", e);
            }
        }

        function playSound(type) {
            if (!audioEnabled || !synth) return;
            try {
                switch(type) {
                    case 'click': synth.triggerAttackRelease("C5", "32n"); break;
                    case 'box':
                        membrane.triggerAttackRelease("C2", "16n");
                        metal.triggerAttackRelease("32n", "+0.05");
                        synth.triggerAttackRelease(["C5", "E5", "G5"], "16n");
                        break;
                    case 'win':
                        const now = Tone.now();
                        metal.triggerAttackRelease("16n", now);
                        metal.triggerAttackRelease("16n", now + 0.1);
                        metal.triggerAttackRelease("16n", now + 0.2);
                        synth.triggerAttackRelease(["C4", "E4", "G4", "C5"], "8n", now);
                        break;
                    case 'error': synth.triggerAttackRelease(["C3", "C#3"], "16n"); break;
                }
            } catch(e) { console.error("Audio error", e); }
        }

        async function speakWinner(winnerName, isDraw = false) {
            if (!voiceEnabled || !speechSynthesis) return;

            if (!voicesLoaded) await loadVoices();
            speechSynthesis.cancel();

            let text = "";
            if (isDraw) {
                text = "It's a draw! Well played both players!";
            } else {
                const cleanName = winnerName.replace(/[^a-zA-Z0-9\s]/g, '');
                text = `Congratulations ${cleanName}! You have won the game!`;
            }

            const utterance = new SpeechSynthesisUtterance(text);
            const voices = speechSynthesis.getVoices();
            const selectedVoice = voices.find(v => v.lang === 'en-US') || voices[0];
            if (selectedVoice) utterance.voice = selectedVoice;
            
            utterance.rate = 0.9;
            utterance.pitch = 1;
            utterance.volume = 1;

            const indicator = document.getElementById('voice-indicator');
            const msgEl = document.getElementById('voice-message');
            
            if (indicator) indicator.classList.remove('hidden');
            if (msgEl) msgEl.textContent = text;

            utterance.onend = () => { if (indicator) indicator.classList.add('hidden'); };
            utterance.onerror = () => { if (indicator) indicator.classList.add('hidden'); };

            setTimeout(() => speechSynthesis.speak(utterance), 100);
        }

        function stopSpeaking() {
            if (speechSynthesis) speechSynthesis.cancel();
            const indicator = document.getElementById('voice-indicator');
            if (indicator) indicator.classList.add('hidden');
        }

        // --- Game State ---
        const state = {
            gridSize: 5,
            currentPlayer: 1,
            scores: { 1: 0, 2: 0 },
            lines: new Set(),
            boxes: {},
            gameOver: false,
            totalBoxes: 0,
            gameMode: 'pvp',
            playerNames: { 1: 'Player 1', 2: 'Player 2' },
            isComputerThinking: false
        };

        // --- DOM Elements ---
        const svg = document.getElementById('game-svg');
        const layerLines = document.getElementById('layer-lines');
        const layerBoxes = document.getElementById('layer-boxes');
        const layerDots = document.getElementById('layer-dots');
        const scoreEls = { 1: document.getElementById('score-p1'), 2: document.getElementById('score-p2') };
        const cardEls = { 1: document.getElementById('p1-card'), 2: document.getElementById('p2-card') };
        const nameEls = { 1: document.getElementById('p1-name-display'), 2: document.getElementById('p2-name-display') };
        const indicatorEls = { 1: document.getElementById('p1-indicator'), 2: document.getElementById('p2-indicator') };
        const turnIndicator = document.getElementById('turn-indicator');
        const thinkingIndicator = document.getElementById('thinking-indicator');

        // --- AI Logic ---
        function getAvailableLines() {
            const available = [];
            const size = state.gridSize;
            
            for (let r = 0; r < size; r++) {
                for (let c = 0; c < size - 1; c++) {
                    const key = `${r},${c},h`;
                    if (!state.lines.has(key)) available.push({r, c, dir: 'h', key});
                }
            }
            for (let r = 0; r < size - 1; r++) {
                for (let c = 0; c < size; c++) {
                    const key = `${r},${c},v`;
                    if (!state.lines.has(key)) available.push({r, c, dir: 'v', key});
                }
            }
            return available;
        }

        function countBoxSides(r, c) {
            const top = `${r},${c},h`;
            const bottom = `${r+1},${c},h`;
            const left = `${r},${c},v`;
            const right = `${r},${c+1},v`;
            
            let count = 0;
            if (state.lines.has(top)) count++;
            if (state.lines.has(bottom)) count++;
            if (state.lines.has(left)) count++;
            if (state.lines.has(right)) count++;
            return count;
        }

        function wouldCompleteBox(r, c, dir) {
            if (dir === 'h') {
                if (r > 0 && countBoxSides(r-1, c) === 3) return true;
                if (r < state.gridSize - 1 && countBoxSides(r, c) === 3) return true;
            } else {
                if (c > 0 && countBoxSides(r, c-1) === 3) return true;
                if (c < state.gridSize - 1 && countBoxSides(r, c) === 3) return true;
            }
            return false;
        }

        function findBestMove() {
            const available = getAvailableLines();
            if (available.length === 0) return null;
            
            const completingMoves = available.filter(m => wouldCompleteBox(m.r, m.c, m.dir));
            if (completingMoves.length > 0) return completingMoves[Math.floor(Math.random() * completingMoves.length)];
            
            const safeMoves = [];
            const riskyMoves = [];
            
            for (const move of available) {
                state.lines.add(move.key);
                let givesBox = false;
                const remaining = getAvailableLines();
                for (const next of remaining) {
                    if (wouldCompleteBox(next.r, next.c, next.dir)) { givesBox = true; break; }
                }
                state.lines.delete(move.key);
                
                if (!givesBox) safeMoves.push(move);
                else riskyMoves.push(move);
            }
            
            if (safeMoves.length > 0) return safeMoves[Math.floor(Math.random() * safeMoves.length)];
            return riskyMoves[Math.floor(Math.random() * riskyMoves.length)];
        }

        async function computerMove() {
            if (state.gameOver || state.currentPlayer !== 2) return;
            
            state.isComputerThinking = true;
            thinkingIndicator.classList.remove('hidden');
            
            await new Promise(r => setTimeout(r, 800 + Math.random() * 600));
            
            if (state.gameOver) {
                thinkingIndicator.classList.add('hidden');
                state.isComputerThinking = false;
                return;
            }
            
            const move = findBestMove();
            if (move) processMove(move.r, move.c, move.dir, move.key);
            
            thinkingIndicator.classList.add('hidden');
            state.isComputerThinking = false;
        }

        // --- Game Logic ---
        function initGame(size = 5, mode = 'pvp', names = {1: 'Player 1', 2: 'Player 2'}) {
            stopSpeaking();
            state.gridSize = size;
            state.gameMode = mode;
            state.playerNames = names;
            state.currentPlayer = 1;
            state.scores = { 1: 0, 2: 0 };
            state.lines.clear();
            state.boxes = {};
            state.gameOver = false;
            state.totalBoxes = (size - 1) * (size - 1);
            state.isComputerThinking = false;
            
            nameEls[1].textContent = names[1];
            nameEls[2].textContent = names[2];
            
            updateScoreboard();
            updateTurnUI();
            renderGrid();
            
            document.getElementById('game-over-modal').classList.add('hidden');
            document.getElementById('game-over-content').classList.remove('scale-100');
            document.getElementById('game-over-content').classList.add('scale-0');
            thinkingIndicator.classList.add('hidden');
            document.getElementById('voice-indicator').classList.add('hidden');
            document.getElementById('voice-message').textContent = '';
        }

        function renderGrid() {
            layerLines.innerHTML = '';
            layerBoxes.innerHTML = '';
            layerDots.innerHTML = '';

            const size = state.gridSize;
            const step = 100 / (size - 1);

            for (let r = 0; r < size - 1; r++) {
                for (let c = 0; c < size - 1; c++) {
                    const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    rect.setAttribute("x", c * step);
                    rect.setAttribute("y", r * step);
                    rect.setAttribute("width", step);
                    rect.setAttribute("height", step);
                    rect.setAttribute("rx", step * 0.1);
                    rect.setAttribute("class", "box-fill");
                    rect.setAttribute("id", `box-${r}-${c}`);
                    layerBoxes.appendChild(rect);
                }
            }

            for (let r = 0; r < size; r++) {
                for (let c = 0; c < size - 1; c++) {
                    createLine(r, c, 'h', step);
                }
            }
            for (let r = 0; r < size - 1; r++) {
                for (let c = 0; c < size; c++) {
                    createLine(r, c, 'v', step);
                }
            }

            for (let r = 0; r < size; r++) {
                for (let c = 0; c < size; c++) {
                    const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                    circle.setAttribute("cx", c * step);
                    circle.setAttribute("cy", r * step);
                    circle.setAttribute("r", step * 0.12);
                    circle.setAttribute("fill", "#4a5568");
                    circle.setAttribute("class", "dot");
                    layerDots.appendChild(circle);
                }
            }
        }

        function createLine(r, c, dir, step) {
            const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
            const isHoriz = dir === 'h';
            
            const x1 = c * step;
            const y1 = r * step;
            const x2 = isHoriz ? (c + 1) * step : c * step;
            const y2 = isHoriz ? r * step : (r + 1) * step;

            const hitArea = document.createElementNS("http://www.w3.org/2000/svg", "line");
            hitArea.setAttribute("x1", x1);
            hitArea.setAttribute("y1", y1);
            hitArea.setAttribute("x2", x2);
            hitArea.setAttribute("y2", y2);
            hitArea.setAttribute("stroke", "transparent");
            hitArea.setAttribute("stroke-width", Math.max(step * 0.5, 8));
            hitArea.style.cursor = "pointer";
            
            line.setAttribute("x1", x1);
            line.setAttribute("y1", y1);
            line.setAttribute("x2", x2);
            line.setAttribute("y2", y2);
            line.setAttribute("stroke", "#2d3748");
            line.setAttribute("stroke-width", step * 0.15);
            line.setAttribute("class", "line");
            line.setAttribute("id", `line-${r}-${c}-${dir}`);

            hitArea.addEventListener('click', (e) => { e.preventDefault(); handleLineClick(r, c, dir); });
            hitArea.addEventListener('touchstart', (e) => { e.preventDefault(); handleLineClick(r, c, dir); }, {passive: false});
            line.addEventListener('click', (e) => { e.preventDefault(); handleLineClick(r, c, dir); });

            layerLines.appendChild(line);
            layerLines.appendChild(hitArea);
        }

        function handleLineClick(r, c, dir) {
            if (state.gameOver || state.isComputerThinking) return;
            if (state.gameMode === 'pvc' && state.currentPlayer === 2) return;
            
            const key = `${r},${c},${dir}`;
            if (state.lines.has(key)) { playSound('error'); return; }

            if (Tone.context.state !== 'running') initAudio();
            processMove(r, c, dir, key);
        }

        function processMove(r, c, dir, key) {
            state.lines.add(key);
            const lineEl = document.getElementById(`line-${r}-${c}-${dir}`);
            lineEl.setAttribute("stroke", state.currentPlayer === 1 ? "#3b82f6" : "#ef4444");
            lineEl.classList.add("active");
            
            playSound('click');

            const completedBoxes = checkBoxes(r, c, dir);
            
            if (completedBoxes.length > 0) {
                completedBoxes.forEach(box => {
                    state.boxes[`${box.r},${box.c}`] = state.currentPlayer;
                    state.scores[state.currentPlayer]++;
                    
                    const boxEl = document.getElementById(`box-${box.r}-${box.c}`);
                    boxEl.classList.add("completed");
                    boxEl.classList.add(state.currentPlayer === 1 ? "p1-fill" : "p2-fill");
                });
                
                playSound('box');
                updateScoreboard();
                
                if (state.scores[1] + state.scores[2] === state.totalBoxes) {
                    endGame();
                    return;
                }
                
                if (state.gameMode === 'pvc' && state.currentPlayer === 2) {
                    setTimeout(computerMove, 500);
                }
            } else {
                state.currentPlayer = state.currentPlayer === 1 ? 2 : 1;
                updateTurnUI();
                
                if (state.gameMode === 'pvc' && state.currentPlayer === 2 && !state.gameOver) {
                    setTimeout(computerMove, 500);
                }
            }
        }

        function checkBoxes(r, c, dir) {
            const completed = [];
            if (dir === 'h') {
                if (r > 0 && isBoxComplete(r - 1, c)) completed.push({r: r-1, c: c});
                if (r < state.gridSize - 1 && isBoxComplete(r, c)) completed.push({r: r, c: c});
            } else {
                if (c > 0 && isBoxComplete(r, c - 1)) completed.push({r: r, c: c-1});
                if (c < state.gridSize - 1 && isBoxComplete(r, c)) completed.push({r: r, c: c});
            }
            return completed;
        }

        function isBoxComplete(r, c) {
            const top = `${r},${c},h`;
            const bottom = `${r+1},${c},h`;
            const left = `${r},${c},v`;
            const right = `${r},${c+1},v`;
            
            return state.lines.has(top) && state.lines.has(bottom) && 
                   state.lines.has(left) && state.lines.has(right);
        }

        function updateScoreboard() {
            scoreEls[1].textContent = state.scores[1];
            scoreEls[2].textContent = state.scores[2];
        }

        function updateTurnUI() {
            const isP1 = state.currentPlayer === 1;
            
            cardEls[1].className = `game-card bg-gray-800 p-2 sm:p-4 rounded-lg sm:rounded-xl border-2 transition-all duration-300 relative overflow-hidden ${isP1 ? 'border-blue-500 scale-105 shadow-lg shadow-blue-900/20' : 'border-gray-700 opacity-70'}`;
            cardEls[2].className = `game-card bg-gray-800 p-2 sm:p-4 rounded-lg sm:rounded-xl border-2 transition-all duration-300 relative overflow-hidden ${!isP1 ? 'border-red-500 scale-105 shadow-lg shadow-red-900/20' : 'border-gray-700 opacity-70'}`;
            
            indicatorEls[1].style.opacity = isP1 ? '1' : '0';
            indicatorEls[2].style.opacity = !isP1 ? '1' : '0';
            
            const currentName = state.playerNames[state.currentPlayer];
            turnIndicator.textContent = `${currentName}'s Turn`;
            turnIndicator.className = `text-center text-xs sm:text-sm font-bold ${isP1 ? 'text-blue-400' : 'text-red-400'} truncate px-4`;
        }

        function endGame() {
            state.gameOver = true;
            playSound('win');
            
            const p1 = state.scores[1];
            const p2 = state.scores[2];
            const isDraw = p1 === p2;
            let winnerText = "";
            let winnerName = "";
            let colorClass = "";

            if (isDraw) {
                winnerText = "It's a Draw!";
                winnerName = "";
                colorClass = "text-gray-200";
            } else if (p1 > p2) {
                winnerName = state.playerNames[1];
                winnerText = `${winnerName} Wins!`;
                colorClass = "text-blue-400";
            } else {
                winnerName = state.playerNames[2];
                winnerText = `${winnerName} Wins!`;
                colorClass = "text-red-400";
            }

            document.getElementById('winner-text').textContent = winnerText;
            document.getElementById('winner-text').className = `text-xl sm:text-3xl font-bold mb-1 sm:mb-2 ${colorClass} px-2`;
            document.getElementById('final-score').textContent = `${p1} - ${p2}`;

            const modal = document.getElementById('game-over-modal');
            const content = document.getElementById('game-over-content');
            
            modal.classList.remove('hidden');
            requestAnimationFrame(() => {
                content.classList.remove('scale-0');
                content.classList.add('scale-100');
            });

            startConfetti();
            setTimeout(() => speakWinner(winnerName, isDraw), 800);
        }

        // --- Setup & Event Listeners ---
        const setupModal = document.getElementById('setup-modal');
        const gameUI = document.getElementById('game-ui');
        let selectedMode = 'pvp';
        let selectedSize = 5;

        loadVoices();

        // Mode selection
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedMode = btn.dataset.mode;
                
                const p2Input = document.getElementById('p2-name-input');
                const p2Label = document.getElementById('p2-label');
                
                if (selectedMode === 'pvc') {
                    p2Input.value = 'Computer';
                    p2Input.disabled = true;
                    p2Label.textContent = 'Computer';
                } else {
                    p2Input.value = 'Player 2';
                    p2Input.disabled = false;
                    p2Label.textContent = 'Player 2 Name';
                }
            });
        });

        // Voice toggle
        const voiceToggle = document.getElementById('voice-toggle');
        voiceToggle.addEventListener('click', () => {
            voiceEnabled = !voiceEnabled;
            voiceToggle.textContent = voiceEnabled ? 'ON' : 'OFF';
            voiceToggle.className = voiceEnabled 
                ? 'px-2 sm:px-3 py-1 bg-green-600 rounded-full text-xs font-bold transition'
                : 'px-2 sm:px-3 py-1 bg-red-600 rounded-full text-xs font-bold transition';
        });

        // Test voice button
        document.getElementById('test-voice-btn').addEventListener('click', async () => {
            const testName = document.getElementById('p1-name-input').value || 'Player 1';
            await speakWinner(testName);
        });

        // Grid size selection
        document.querySelectorAll('.grid-select-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.grid-select-btn').forEach(b => {
                    b.className = 'grid-select-btn py-2 rounded-lg border-2 border-gray-600 hover:border-gray-500 font-semibold text-xs sm:text-sm transition';
                });
                btn.className = 'grid-select-btn py-2 rounded-lg border-2 border-blue-500 bg-blue-500/20 text-blue-400 font-semibold text-xs sm:text-sm transition';
                selectedSize = parseInt(btn.dataset.size);
            });
        });

        // Start game
        document.getElementById('start-game-btn').addEventListener('click', async () => {
            const p1Name = document.getElementById('p1-name-input').value.trim() || 'Player 1';
            const p2Name = document.getElementById('p2-name-input').value.trim() || 'Player 2';
            
            await initAudio();
            initGame(selectedSize, selectedMode, {1: p1Name, 2: p2Name});
            
            setupModal.style.opacity = '0';
            setTimeout(() => {
                setupModal.classList.add('hidden');
                gameUI.classList.remove('hidden');
                setTimeout(() => gameUI.classList.remove('opacity-0'), 50);
            }, 300);
        });

        // New game
        document.getElementById('new-game-btn').addEventListener('click', () => {
            stopSpeaking();
            gameUI.classList.add('opacity-0');
            setTimeout(() => {
                gameUI.classList.add('hidden');
                setupModal.classList.remove('hidden');
                setupModal.style.opacity = '1';
            }, 500);
        });

        document.getElementById('menu-btn').addEventListener('click', () => {
            stopSpeaking();
            document.getElementById('game-over-modal').classList.add('hidden');
            document.getElementById('new-game-btn').click();
        });

        // Restart button - now clearly visible below game
        document.getElementById('restart-btn').addEventListener('click', () => {
            stopSpeaking();
            initGame(state.gridSize, state.gameMode, state.playerNames);
        });

        document.getElementById('play-again-btn').addEventListener('click', () => {
            stopSpeaking();
            initGame(state.gridSize, state.gameMode, state.playerNames);
        });

        // Confetti
        const canvas = document.getElementById('confetti-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function startConfetti() {
            particles = [];
            const colors = ['#3b82f6', '#ef4444', '#fbbf24', '#10b981', '#8b5cf6'];
            for (let i = 0; i < 150; i++) {
                particles.push({
                    x: canvas.width / 2,
                    y: canvas.height / 2,
                    vx: (Math.random() - 0.5) * 15,
                    vy: (Math.random() - 0.5) * 15 - 5,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    size: Math.random() * 8 + 4,
                    rotation: Math.random() * 360,
                    rotationSpeed: (Math.random() - 0.5) * 10,
                    gravity: 0.2,
                    drag: 0.96
                });
            }
            animateConfetti();
        }

        function animateConfetti() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach((p, i) => {
                p.x += p.vx; p.y += p.vy;
                p.vy += p.gravity;
                p.vx *= p.drag; p.vy *= p.drag;
                p.rotation += p.rotationSpeed;
                ctx.save();
                ctx.translate(p.x, p.y);
                ctx.rotate((p.rotation * Math.PI) / 180);
                ctx.fillStyle = p.color;
                ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
                ctx.restore();
                if (p.y > canvas.height) particles.splice(i, 1);
            });
            if (particles.length > 0) requestAnimationFrame(animateConfetti);
        }

        // Prevent double-tap zoom
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (e) => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) e.preventDefault();
            lastTouchEnd = now;
        }, false);
    </script>
</body>
</html>
