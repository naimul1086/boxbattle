<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Box Battle - Dots & Boxes</title>
   <script src="https://cdn.tailwindcss.com"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
   <style>
       @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap');

       body {
           font-family: 'Fredoka', sans-serif;
           background-color: #1a202c; /* Tailwind gray-900 */
           color: #e2e8f0;
           overflow-x: hidden;
           touch-action: manipulation; /* Prevent double-tap zoom */
       }

       /* Game Container Aspect Ratio */
       #game-wrapper {
           position: relative;
           width: 100%;
           max-width: 500px;
           margin: 0 auto;
           aspect-ratio: 1 / 1;
       }

       /* SVG Layering */
       svg {
           position: absolute;
           top: 0;
           left: 0;
           width: 100%;
           height: 100%;
           overflow: visible;
       }

       /* Interactive Elements */
       .line {
           stroke-linecap: round;
           transition: stroke 0.2s ease, filter 0.2s ease;
           cursor: pointer;
       }

       .line:hover:not(.active) {
           stroke: rgba(255, 255, 255, 0.3);
       }

       .line.active {
           cursor: default;
       }

       .dot {
           pointer-events: none;
           z-index: 10;
       }

       .box-fill {
           opacity: 0;
           transition: opacity 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
       }

       .box-fill.completed {
           opacity: 1;
       }

       /* Player Colors (Dynamic classes applied via JS) */
       .p1-color { color: #3b82f6; } /* Blue-500 */
       .p2-color { color: #ef4444; } /* Red-500 */
       
       .p1-bg { background-color: #3b82f6; }
       .p2-bg { background-color: #ef4444; }

       .p1-stroke { stroke: #3b82f6; }
       .p2-stroke { stroke: #ef4444; }

       .p1-fill { fill: rgba(59, 130, 246, 0.4); }
       .p2-fill { fill: rgba(239, 68, 68, 0.4); }

       /* UI Animations */
       @keyframes pulse-border {
           0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4); }
           70% { box-shadow: 0 0 0 10px rgba(255, 255, 255, 0); }
           100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
       }

       .turn-active {
           animation: pulse-border 2s infinite;
           border-color: white;
       }

       /* Modal */
       .modal-backdrop {
           background-color: rgba(0, 0, 0, 0.8);
           backdrop-filter: blur(5px);
       }

       /* Confetti Canvas */
       #confetti-canvas {
           position: fixed;
           top: 0;
           left: 0;
           width: 100%;
           height: 100%;
           pointer-events: none;
           z-index: 50;
       }
   </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

   <!-- Header / Scoreboard -->
   <header class="w-full max-w-lg mb-6 flex flex-col gap-4">
       <div class="flex justify-between items-center">
           <h1 class="text-3xl font-bold tracking-wider bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-red-400">
               BOX BATTLE
           </h1>
           <button id="settings-btn" class="text-gray-400 hover:text-white transition">
               <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
               </svg>
           </button>
       </div>

       <!-- Score Board -->
       <div class="grid grid-cols-2 gap-4">
           <div id="p1-card" class="bg-gray-800 p-4 rounded-xl border-2 border-blue-500 transition-all duration-300 transform scale-105 shadow-lg shadow-blue-900/20">
               <div class="text-xs text-gray-400 uppercase font-bold">Player 1</div>
               <div class="text-3xl font-bold p1-color" id="score-p1">0</div>
           </div>
           <div id="p2-card" class="bg-gray-800 p-4 rounded-xl border-2 border-gray-700 transition-all duration-300 opacity-70">
               <div class="text-xs text-gray-400 uppercase font-bold">Player 2</div>
               <div class="text-3xl font-bold p2-color" id="score-p2">0</div>
           </div>
       </div>
       
       <div class="text-center text-sm text-gray-400" id="turn-indicator">Player 1's Turn</div>
   </header>

   <!-- Game Area -->
   <main class="w-full max-w-lg relative">
       <div id="game-wrapper">
           <!-- SVG Container -->
           <svg id="game-svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet">
               <!-- Layers: Boxes -> Lines -> Dots -->
               <g id="layer-boxes"></g>
               <g id="layer-lines"></g>
               <g id="layer-dots"></g>
           </svg>
       </div>
   </main>

   <!-- Controls -->
   <footer class="mt-8 flex gap-4">
       <button id="restart-btn" class="px-6 py-3 bg-gray-700 hover:bg-gray-600 rounded-full font-bold transition shadow-lg flex items-center gap-2">
           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
               <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
           </svg>
           Restart
       </button>
   </footer>

   <!-- Settings Modal -->
   <div id="settings-modal" class="fixed inset-0 modal-backdrop hidden flex items-center justify-center z-40 opacity-0 transition-opacity duration-300">
       <div class="bg-gray-800 p-6 rounded-2xl max-w-sm w-full mx-4 shadow-2xl transform scale-95 transition-transform duration-300 border border-gray-700">
           <h2 class="text-2xl font-bold mb-4 text-white">Game Settings</h2>
           
           <div class="mb-6">
               <label class="block text-gray-400 text-sm font-bold mb-2">Grid Size</label>
               <div class="grid grid-cols-3 gap-2">
                   <button class="grid-size-btn bg-gray-700 hover:bg-gray-600 py-2 rounded-lg text-sm font-semibold transition" data-size="4">4 x 4</button>
                   <button class="grid-size-btn bg-blue-600 text-white py-2 rounded-lg text-sm font-semibold transition ring-2 ring-blue-400" data-size="5">5 x 5</button>
                   <button class="grid-size-btn bg-gray-700 hover:bg-gray-600 py-2 rounded-lg text-sm font-semibold transition" data-size="6">6 x 6</button>
               </div>
           </div>

           <div class="mb-6">
               <label class="block text-gray-400 text-sm font-bold mb-2">Sound</label>
               <button id="sound-toggle" class="w-full py-2 bg-green-600 hover:bg-green-500 rounded-lg font-bold transition">ON</button>
           </div>

           <button id="close-settings" class="w-full py-3 bg-gray-700 hover:bg-gray-600 rounded-xl font-bold transition">Close</button>
       </div>
   </div>

   <!-- Game Over Modal -->
   <div id="game-over-modal" class="fixed inset-0 modal-backdrop hidden flex items-center justify-center z-50">
       <div class="bg-gray-800 p-8 rounded-3xl max-w-sm w-full mx-4 shadow-2xl text-center border border-gray-700 transform scale-0 transition-transform duration-500" id="game-over-content">
           <div class="mb-4 text-6xl">üèÜ</div>
           <h2 class="text-3xl font-bold mb-2 text-white" id="winner-text">Player 1 Wins!</h2>
           <p class="text-gray-400 mb-8" id="final-score">5 - 3</p>
           <button id="play-again-btn" class="w-full py-4 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-400 hover:to-purple-500 rounded-xl font-bold text-lg shadow-lg transform transition hover:scale-105">
               Play Again
           </button>
       </div>
   </div>

   <canvas id="confetti-canvas"></canvas>

   <script>
       /**
        * BOX BATTLE - GAME LOGIC
        */

       // --- Audio System (Tone.js) ---
       let audioEnabled = true;
       let synth, membrane, metal;

       async function initAudio() {
           if (!audioEnabled) return;
           await Tone.start();
           
           // Simple synth for UI sounds
           synth = new Tone.PolySynth(Tone.Synth).toDestination();
           synth.volume.value = -10;

           // Membrane for thuds
           membrane = new Tone.MembraneSynth().toDestination();
           membrane.volume.value = -15;

           // Metal for completion chime
           metal = new Tone.MetalSynth({
               frequency: 200,
               envelope: { attack: 0.001, decay: 0.1, release: 0.01 },
               harmonicity: 5.1,
               modulationIndex: 32,
               resonance: 4000,
               octaves: 1.5
           }).toDestination();
           metal.volume.value = -20;
       }

       function playSound(type) {
           if (!audioEnabled || !synth) return;
           try {
               switch(type) {
                   case 'click':
                       synth.triggerAttackRelease("C5", "32n");
                       break;
                   case 'box':
                       membrane.triggerAttackRelease("C2", "16n");
                       metal.triggerAttackRelease("32n", "+0.05");
                       // Play a little chord
                       synth.triggerAttackRelease(["C5", "E5", "G5"], "16n");
                       break;
                   case 'win':
                       const now = Tone.now();
                       metal.triggerAttackRelease("16n", now);
                       metal.triggerAttackRelease("16n", now + 0.1);
                       metal.triggerAttackRelease("16n", now + 0.2);
                       synth.triggerAttackRelease(["C4", "E4", "G4", "C5"], "8n", now);
                       break;
                   case 'error':
                       synth.triggerAttackRelease(["C3", "C#3"], "16n");
                       break;
               }
           } catch(e) { console.error("Audio error", e); }
       }

       // --- Game State ---
       const state = {
           gridSize: 5, // Number of dots (e.g., 5 means 4x4 boxes)
           currentPlayer: 1, // 1 or 2
           scores: { 1: 0, 2: 0 },
           lines: new Set(), // Set of "r,c,dir" strings
           boxes: {}, // Key: "r,c", Value: 0 (empty), 1 (p1), 2 (p2)
           gameOver: false,
           totalBoxes: 0
       };

       // --- DOM Elements ---
       const svg = document.getElementById('game-svg');
       const layerLines = document.getElementById('layer-lines');
       const layerBoxes = document.getElementById('layer-boxes');
       const layerDots = document.getElementById('layer-dots');
       const scoreEls = { 1: document.getElementById('score-p1'), 2: document.getElementById('score-p2') };
       const cardEls = { 1: document.getElementById('p1-card'), 2: document.getElementById('p2-card') };
       const turnIndicator = document.getElementById('turn-indicator');
       
       // --- Initialization ---
       function initGame(size = 5) {
           state.gridSize = size;
           state.currentPlayer = 1;
           state.scores = { 1: 0, 2: 0 };
           state.lines.clear();
           state.boxes = {};
           state.gameOver = false;
           state.totalBoxes = (size - 1) * (size - 1);
           
           updateScoreboard();
           updateTurnUI();
           renderGrid();
           
           // Hide modals
           document.getElementById('game-over-modal').classList.add('hidden');
           document.getElementById('game-over-content').classList.remove('scale-100');
           document.getElementById('game-over-content').classList.add('scale-0');
       }

       // --- Rendering ---
       function renderGrid() {
           // Clear SVG layers
           layerLines.innerHTML = '';
           layerBoxes.innerHTML = '';
           layerDots.innerHTML = '';

           const size = state.gridSize;
           const step = 100 / (size - 1); // Percentage step between dots

           // 1. Draw Boxes (Invisible initially, just containers)
           // We draw boxes first so they are behind lines
           for (let r = 0; r < size - 1; r++) {
               for (let c = 0; c < size - 1; c++) {
                   const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                   rect.setAttribute("x", c * step + step/2); // Centered in the gap
                   rect.setAttribute("y", r * step + step/2);
                   rect.setAttribute("width", step);
                   rect.setAttribute("height", step);
                   rect.setAttribute("class", "box-fill");
                   rect.setAttribute("id", `box-${r}-${c}`);
                   // Adjust coordinates to align with lines
                   // Actually, lines are drawn between dots. 
                   // Dot at (r,c) is at (c*step, r*step).
                   // Box top-left is at (c*step, r*step).
                   // Let's adjust logic.
                   
                   // Correct positioning:
                   // Dot (r,c) -> (c*step, r*step)
                   // Box (r,c) (box below/right of dot r,c) -> TopLeft: (c*step, r*step), BottomRight: ((c+1)*step, (r+1)*step)
                   
                   rect.setAttribute("x", c * step);
                   rect.setAttribute("y", r * step);
                   rect.setAttribute("width", step);
                   rect.setAttribute("height", step);
                   rect.setAttribute("rx", step * 0.1); // Rounded corners
                   
                   layerBoxes.appendChild(rect);
               }
           }

           // 2. Draw Lines (Interactive)
           // Horizontal lines
           for (let r = 0; r < size; r++) {
               for (let c = 0; c < size - 1; c++) {
                   createLine(r, c, 'h', step);
               }
           }
           // Vertical lines
           for (let r = 0; r < size - 1; r++) {
               for (let c = 0; c < size; c++) {
                   createLine(r, c, 'v', step);
               }
           }

           // 3. Draw Dots
           for (let r = 0; r < size; r++) {
               for (let c = 0; c < size; c++) {
                   const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                   circle.setAttribute("cx", c * step);
                   circle.setAttribute("cy", r * step);
                   circle.setAttribute("r", step * 0.12);
                   circle.setAttribute("fill", "#4a5568"); // Gray-700
                   circle.setAttribute("class", "dot");
                   layerDots.appendChild(circle);
               }
           }
       }

       function createLine(r, c, dir, step) {
           const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
           const isHoriz = dir === 'h';
           
           // Coordinates
           const x1 = c * step;
           const y1 = r * step;
           const x2 = isHoriz ? (c + 1) * step : c * step;
           const y2 = isHoriz ? r * step : (r + 1) * step;

           // Invisible hit area (thicker)
           const hitArea = document.createElementNS("http://www.w3.org/2000/svg", "line");
           hitArea.setAttribute("x1", x1);
           hitArea.setAttribute("y1", y1);
           hitArea.setAttribute("x2", x2);
           hitArea.setAttribute("y2", y2);
           hitArea.setAttribute("stroke", "transparent");
           hitArea.setAttribute("stroke-width", step * 0.4);
           hitArea.style.cursor = "pointer";
           
           // Visible line
           line.setAttribute("x1", x1);
           line.setAttribute("y1", y1);
           line.setAttribute("x2", x2);
           line.setAttribute("y2", y2);
           line.setAttribute("stroke", "#2d3748"); // Gray-800
           line.setAttribute("stroke-width", step * 0.15);
           line.setAttribute("class", "line");
           line.setAttribute("id", `line-${r}-${c}-${dir}`);

           // Event Listener
           hitArea.addEventListener('click', () => handleLineClick(r, c, dir));
           // Also attach to visible line for robustness
           line.addEventListener('click', () => handleLineClick(r, c, dir));

           layerLines.appendChild(line);
           layerLines.appendChild(hitArea);
       }

       // --- Game Logic ---

       function handleLineClick(r, c, dir) {
           if (state.gameOver) return;
           
           const key = `${r},${c},${dir}`;
           if (state.lines.has(key)) {
               playSound('error');
               return; // Already taken
           }

           // Init audio on first interaction if not already
           if (Tone.context.state !== 'running') {
               initAudio();
           }

           // Claim Line
           state.lines.add(key);
           const lineEl = document.getElementById(`line-${r}-${c}-${dir}`);
           lineEl.setAttribute("stroke", state.currentPlayer === 1 ? "#3b82f6" : "#ef4444");
           lineEl.classList.add("active");
           
           playSound('click');

           // Check Boxes
           const completedBoxes = checkBoxes(r, c, dir);
           
           if (completedBoxes.length > 0) {
               // Player scores
               completedBoxes.forEach(box => {
                   state.boxes[`${box.r},${box.c}`] = state.currentPlayer;
                   state.scores[state.currentPlayer]++;
                   
                   // Animate Box
                   const boxEl = document.getElementById(`box-${box.r}-${box.c}`);
                   boxEl.classList.add("completed");
                   boxEl.classList.add(state.currentPlayer === 1 ? "p1-fill" : "p2-fill");
               });
               
               playSound('box');
               updateScoreboard();
               
               // Check Win Condition
               if (state.scores[1] + state.scores[2] === state.totalBoxes) {
                   endGame();
                   return;
               }
               
               // Extra turn - Do not switch player
           } else {
               // Switch Player
               state.currentPlayer = state.currentPlayer === 1 ? 2 : 1;
               updateTurnUI();
           }
       }

       function checkBoxes(r, c, dir) {
           const completed = [];
           
           if (dir === 'h') {
               // Line is at row r, between col c and c+1
               // It could complete the box above (r-1, c) or below (r, c)
               
               // Check Above (if r > 0)
               if (r > 0) {
                   if (isBoxComplete(r - 1, c)) completed.push({r: r-1, c: c});
               }
               // Check Below (if r < gridSize - 1)
               if (r < state.gridSize - 1) {
                   if (isBoxComplete(r, c)) completed.push({r: r, c: c});
               }
           } else {
               // Line is vertical at col c, between row r and r+1
               // It could complete the box left (r, c-1) or right (r, c)
               
               // Check Left (if c > 0)
               if (c > 0) {
                   if (isBoxComplete(r, c - 1)) completed.push({r: r, c: c-1});
               }
               // Check Right (if c < gridSize - 1)
               if (c < state.gridSize - 1) {
                   if (isBoxComplete(r, c)) completed.push({r: r, c: c});
               }
           }
           return completed;
       }

       function isBoxComplete(r, c) {
           // Box (r,c) needs:
           // Top: r,c,h
           // Bottom: r+1,c,h
           // Left: r,c,v
           // Right: r,c+1,v
           
           const top = `${r},${c},h`;
           const bottom = `${r+1},${c},h`;
           const left = `${r},${c},v`;
           const right = `${r},${c+1},v`;

           return state.lines.has(top) && 
                  state.lines.has(bottom) && 
                  state.lines.has(left) && 
                  state.lines.has(right);
       }

       // --- UI Updates ---

       function updateScoreboard() {
           scoreEls[1].textContent = state.scores[1];
           scoreEls[2].textContent = state.scores[2];
       }

       function updateTurnUI() {
           const p1Card = cardEls[1];
           const p2Card = cardEls[2];
           
           if (state.currentPlayer === 1) {
               p1Card.classList.remove('border-gray-700', 'opacity-70');
               p1Card.classList.add('border-blue-500', 'scale-105', 'shadow-lg', 'shadow-blue-900/20');
               
               p2Card.classList.add('border-gray-700', 'opacity-70');
               p2Card.classList.remove('border-red-500', 'scale-105', 'shadow-lg', 'shadow-red-900/20');
               
               turnIndicator.textContent = "Player 1's Turn (Blue)";
               turnIndicator.className = "text-center text-sm font-bold text-blue-400";
           } else {
               p2Card.classList.remove('border-gray-700', 'opacity-70');
               p2Card.classList.add('border-red-500', 'scale-105', 'shadow-lg', 'shadow-red-900/20');
               
               p1Card.classList.add('border-gray-700', 'opacity-70');
               p1Card.classList.remove('border-blue-500', 'scale-105', 'shadow-lg', 'shadow-blue-900/20');
               
               turnIndicator.textContent = "Player 2's Turn (Red)";
               turnIndicator.className = "text-center text-sm font-bold text-red-400";
           }
       }

       function endGame() {
           state.gameOver = true;
           playSound('win');
           
           const p1 = state.scores[1];
           const p2 = state.scores[2];
           let winnerText = "";
           let colorClass = "";

           if (p1 > p2) {
               winnerText = "Player 1 Wins!";
               colorClass = "text-blue-400";
           } else if (p2 > p1) {
               winnerText = "Player 2 Wins!";
               colorClass = "text-red-400";
           } else {
               winnerText = "It's a Draw!";
               colorClass = "text-gray-200";
           }

           document.getElementById('winner-text').textContent = winnerText;
           document.getElementById('winner-text').className = `text-3xl font-bold mb-2 ${colorClass}`;
           document.getElementById('final-score').textContent = `${p1} - ${p2}`;

           const modal = document.getElementById('game-over-modal');
           const content = document.getElementById('game-over-content');
           
           modal.classList.remove('hidden');
           // Trigger reflow
           void modal.offsetWidth;
           
           // Animate in
           requestAnimationFrame(() => {
               content.classList.remove('scale-0');
               content.classList.add('scale-100');
           });

           startConfetti();
       }

       // --- Event Listeners ---

       document.getElementById('restart-btn').addEventListener('click', () => {
           initGame(state.gridSize);
       });

       document.getElementById('play-again-btn').addEventListener('click', () => {
           initGame(state.gridSize);
       });

       // Settings Modal Logic
       const settingsModal = document.getElementById('settings-modal');
       const settingsBtn = document.getElementById('settings-btn');
       const closeSettingsBtn = document.getElementById('close-settings');
       const gridSizeBtns = document.querySelectorAll('.grid-size-btn');
       const soundToggle = document.getElementById('sound-toggle');

       function toggleSettings(show) {
           if (show) {
               settingsModal.classList.remove('hidden');
               setTimeout(() => {
                   settingsModal.classList.remove('opacity-0');
                   settingsModal.querySelector('div').classList.remove('scale-95');
                   settingsModal.querySelector('div').classList.add('scale-100');
               }, 10);
           } else {
               settingsModal.classList.add('opacity-0');
               settingsModal.querySelector('div').classList.remove('scale-100');
               settingsModal.querySelector('div').classList.add('scale-95');
               setTimeout(() => {
                   settingsModal.classList.add('hidden');
               }, 300);
           }
       }

       settingsBtn.addEventListener('click', () => toggleSettings(true));
       closeSettingsBtn.addEventListener('click', () => toggleSettings(false));

       gridSizeBtns.forEach(btn => {
           btn.addEventListener('click', (e) => {
               // UI update
               gridSizeBtns.forEach(b => {
                   b.classList.remove('bg-blue-600', 'text-white', 'ring-2', 'ring-blue-400');
                   b.classList.add('bg-gray-700');
               });
               e.target.classList.remove('bg-gray-700');
               e.target.classList.add('bg-blue-600', 'text-white', 'ring-2', 'ring-blue-400');
               
               // Logic update
               const newSize = parseInt(e.target.dataset.size);
               if (newSize !== state.gridSize) {
                   initGame(newSize);
               }
           });
       });

       soundToggle.addEventListener('click', () => {
           audioEnabled = !audioEnabled;
           soundToggle.textContent = audioEnabled ? "ON" : "OFF";
           soundToggle.className = audioEnabled 
               ? "w-full py-2 bg-green-600 hover:bg-green-500 rounded-lg font-bold transition"
               : "w-full py-2 bg-red-600 hover:bg-red-500 rounded-lg font-bold transition";
           
           if (audioEnabled) initAudio();
       });

       // --- Confetti Effect (Simple Canvas) ---
       const canvas = document.getElementById('confetti-canvas');
       const ctx = canvas.getContext('2d');
       let particles = [];
       let animationId;

       function resizeCanvas() {
           canvas.width = window.innerWidth;
           canvas.height = window.innerHeight;
       }
       window.addEventListener('resize', resizeCanvas);
       resizeCanvas();

       function startConfetti() {
           particles = [];
           const colors = ['#3b82f6', '#ef4444', '#fbbf24', '#10b981', '#8b5cf6'];
           for (let i = 0; i < 150; i++) {
               particles.push({
                   x: canvas.width / 2,
                   y: canvas.height / 2,
                   vx: (Math.random() - 0.5) * 15,
                   vy: (Math.random() - 0.5) * 15 - 5,
                   color: colors[Math.floor(Math.random() * colors.length)],
                   size: Math.random() * 8 + 4,
                   rotation: Math.random() * 360,
                   rotationSpeed: (Math.random() - 0.5) * 10,
                   gravity: 0.2,
                   drag: 0.96
               });
           }
           animateConfetti();
       }

       function animateConfetti() {
           ctx.clearRect(0, 0, canvas.width, canvas.height);
           
           particles.forEach((p, index) => {
               p.x += p.vx;
               p.y += p.vy;
               p.vy += p.gravity;
               p.vx *= p.drag;
               p.vy *= p.drag;
               p.rotation += p.rotationSpeed;

               ctx.save();
               ctx.translate(p.x, p.y);
               ctx.rotate((p.rotation * Math.PI) / 180);
               ctx.fillStyle = p.color;
               ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size);
               ctx.restore();

               if (p.y > canvas.height) {
                   particles.splice(index, 1);
               }
           });

           if (particles.length > 0) {
               animationId = requestAnimationFrame(animateConfetti);
           }
       }

       // --- Start Game ---
       initGame(5);

   </script>
</body>
</html>
